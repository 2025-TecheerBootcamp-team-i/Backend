server:
  log_level: info

metrics:
  global:
    scrape_interval: 15s
    external_labels:
      cluster: 'production'
      environment: 'aws-ec2'
  wal_directory: /tmp/agent/wal
  configs:
    - name: default
      remote_write:
        - url: https://prometheus-prod-49-prod-ap-northeast-0.grafana.net/api/prom/push
          basic_auth:
            username: 2926985
            password: ${GRAFANA_CLOUD_TOKEN}
          queue_config:
            capacity: 10000
            max_shards: 50
            max_samples_per_send: 2000
     
          # 전송 직전 이름 강제 통일 (유지)
          write_relabel_configs:
            - target_label: instance
              replacement: 'backend-server'
              action: replace
              
      # Django 애플리케이션 메트릭 수집
      scrape_configs:
        # 1. Grafana Agent 자체 메트릭
        - job_name: 'grafana-agent'
          static_configs:
            - targets: ['localhost:12345']
              labels:
                instance: 'backend-server'
                service: 'grafana-agent'
        
        # 2. Django Prometheus 메트릭
        - job_name: 'django'
          static_configs:
            - targets: ['backend:8000']
              labels:
                instance: 'backend-server'
                service: 'django-backend'
          metrics_path: '/metrics'

# ===== 핵심: Node Exporter 통합 (서버 메트릭) =====
integrations:
  node_exporter:
    enabled: true
    # 인스턴스 라벨 (Grafana Cloud에서 식별)
    instance: 'backend-server'
    
    # 호스트 파일시스템 경로 (Docker 볼륨 마운트와 일치)
    rootfs_path: /host/root
    sysfs_path: /host/sys
    procfs_path: /host/proc
    
    # 활성화할 수집기
    enable_collectors:
      - cpu
      - meminfo
      - diskstats
      - filesystem
      - netdev
      - netstat
      - loadavg
      - time
    
    # 파일시스템 마운트 포인트 필터 (불필요한 항목 제외)
    filesystem_mount_points_exclude: "^/(dev|proc|sys|var/lib/docker/.+|var/lib/kubelet/.+)($|/)"
    filesystem_fs_types_exclude: "^(autofs|binfmt_misc|bpf|cgroup2?|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|iso9660|mqueue|nsfs|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|selinuxfs|squashfs|sysfs|tracefs)$"

  # cAdvisor 통합 (Docker 컨테이너 메트릭)
  cadvisor:
    enabled: true
    instance: 'backend-server'
    docker_only: true
    # Docker 소켓 경로
    docker: unix:///var/run/docker.sock
