<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸµ ìŒì•… ìƒì„± ëª¨ë‹ˆí„°ë§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .music-id {
            text-align: center;
            color: #999;
            margin-bottom: 30px;
            font-size: 0.9em;
        }
        
        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 20px;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .info-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .info-value {
            font-size: 1.1em;
            color: #333;
            word-break: break-word;
        }
        
        .progress-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .progress-bar.indeterminate {
            width: 100% !important;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #667eea 100%);
            background-size: 200% 100%;
            animation: indeterminate 1.5s linear infinite;
        }
        
        @keyframes indeterminate {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .audio-player {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .audio-player.show {
            display: block;
        }
        
        .audio-player h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        audio {
            width: 100%;
            margin-bottom: 15px;
        }
        
        .download-btn {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .lyrics-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        
        .lyrics-container.show {
            display: block;
        }
        
        .lyrics-container h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .lyrics {
            white-space: pre-wrap;
            line-height: 1.8;
            color: #333;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }
        
        .update-time {
            text-align: center;
            color: #999;
            font-size: 0.85em;
            margin-top: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .log-container {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }
        
        .log-entry {
            margin-bottom: 5px;
        }
        
        .log-time {
            color: #888;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ìŒì•… ìƒì„± ëª¨ë‹ˆí„°ë§</h1>
        <div class="music-id">Music ID: <strong id="musicIdDisplay">{{ music_id }}</strong></div>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <span class="status-badge" id="statusBadge">â³ ìƒì„± ì¤‘...</span>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar-container">
                <div class="progress-bar indeterminate" id="progressBar">
                    ìƒì„± ì¤‘...
                </div>
            </div>
        </div>
        
        <div class="info-grid">
            <div class="info-card">
                <div class="info-label">ğŸµ ìŒì•… ì œëª©</div>
                <div class="info-value" id="musicName">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">ğŸ¤ ì•„í‹°ìŠ¤íŠ¸</div>
                <div class="info-value" id="artistName">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">ğŸ’¿ ì•¨ë²”</div>
                <div class="info-value" id="albumName">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">ğŸ¼ ì¥ë¥´</div>
                <div class="info-value" id="genre">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">â±ï¸ ê¸¸ì´</div>
                <div class="info-value" id="duration">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">ğŸ˜Š Valence</div>
                <div class="info-value" id="valence">-</div>
            </div>
        </div>
        
        <div class="audio-player" id="audioPlayer">
            <h3>ğŸ§ ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´</h3>
            <audio controls id="audioElement">
                <source id="audioSource" src="" type="audio/mpeg">
                Your browser does not support the audio element.
            </audio>
            <a href="#" id="downloadLink" class="download-btn" download>â¬‡ï¸ ë‹¤ìš´ë¡œë“œ</a>
        </div>
        
        <div class="lyrics-container" id="lyricsContainer">
            <h3>ğŸ“ ê°€ì‚¬</h3>
            <div class="lyrics" id="lyrics">-</div>
        </div>
        
        <div class="log-container" id="logContainer">
            <div class="log-entry">
                <span class="log-time" id="initTime"></span>
                <span>ëª¨ë‹ˆí„°ë§ ì‹œì‘...</span>
            </div>
        </div>
        
        <div class="update-time">
            ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdate">-</span>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button id="stopBtn" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: none;">
                â¹ï¸ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
            </button>
            <button id="startBtn" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: none;">
                â–¶ï¸ ëª¨ë‹ˆí„°ë§ ì¬ì‹œì‘
            </button>
        </div>
    </div>
    
    <script>
        const musicId = {{ music_id }};
        let isCompleted = false;
        let updateInterval;
        let isMonitoring = true;
        let updateCount = 0;
        const MAX_UPDATES = 120; // ìµœëŒ€ 120íšŒ (10ë¶„ = 120 * 5ì´ˆ)
        const TIMEOUT_MS = 10 * 60 * 1000; // 10ë¶„ íƒ€ì„ì•„ì›ƒ
        const startTime = Date.now();
        
        function addLog(message) {
            const logContainer = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString('ko-KR');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">[${time}]</span><span>${message}</span>`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function formatDuration(seconds) {
            if (!seconds) return '-';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function updateStatus(data) {
            // ì œëª©
            document.getElementById('musicName').textContent = data.music_name || '-';
            
            // ì•„í‹°ìŠ¤íŠ¸
            const artistName = data.artist_name || (data.artist?.artist_name) || 'AI Artist';
            document.getElementById('artistName').textContent = artistName;
            
            // ì•¨ë²”
            const albumName = data.album_name || (data.album?.album_name) || '-';
            document.getElementById('albumName').textContent = albumName;
            
            // ì¥ë¥´
            document.getElementById('genre').textContent = data.genre || '-';
            
            // ê¸¸ì´
            document.getElementById('duration').textContent = formatDuration(data.duration);
            
            // Valence
            if (data.valence) {
                document.getElementById('valence').textContent = parseFloat(data.valence).toFixed(2);
            }
            
            // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ko-KR');
            
            // ì˜¤ë””ì˜¤ê°€ ìˆìœ¼ë©´ í‘œì‹œ
            if (data.audio_url) {
                const audioPlayer = document.getElementById('audioPlayer');
                const audioElement = document.getElementById('audioElement');
                const audioSource = document.getElementById('audioSource');
                const downloadLink = document.getElementById('downloadLink');
                
                audioSource.src = data.audio_url;
                audioElement.load();
                downloadLink.href = data.audio_url;
                audioPlayer.classList.add('show');
                
                // ìƒíƒœ ì—…ë°ì´íŠ¸
                const statusBadge = document.getElementById('statusBadge');
                statusBadge.textContent = 'âœ… ì™„ë£Œ';
                statusBadge.className = 'status-badge status-completed';
                
                // í”„ë¡œê·¸ë ˆìŠ¤ ë°”
                const progressBar = document.getElementById('progressBar');
                progressBar.classList.remove('indeterminate');
                progressBar.style.width = '100%';
                progressBar.textContent = 'ì™„ë£Œ!';
                
                addLog('âœ… ìŒì•… ìƒì„± ì™„ë£Œ!');
                addLog(`ğŸµ ì˜¤ë””ì˜¤ URL: ${data.audio_url}`);
                
                isCompleted = true;
                if (updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = null;
                }
                document.getElementById('stopBtn').style.display = 'none';
                document.getElementById('startBtn').style.display = 'none';
            }
            
            // ê°€ì‚¬ê°€ ìˆìœ¼ë©´ í‘œì‹œ
            if (data.lyrics) {
                const lyricsContainer = document.getElementById('lyricsContainer');
                const lyrics = document.getElementById('lyrics');
                lyrics.textContent = data.lyrics;
                lyricsContainer.classList.add('show');
                
                addLog('ğŸ“ ê°€ì‚¬ ë¡œë“œ ì™„ë£Œ');
            }
        }
        
        async function fetchMusicStatus() {
            // íƒ€ì„ì•„ì›ƒ ì²´í¬
            const elapsed = Date.now() - startTime;
            if (elapsed > TIMEOUT_MS) {
                addLog('â° íƒ€ì„ì•„ì›ƒ: 10ë¶„ì´ ì§€ë‚˜ ëª¨ë‹ˆí„°ë§ì„ ì¤‘ì§€í•©ë‹ˆë‹¤.');
                stopMonitoring();
                const statusBadge = document.getElementById('statusBadge');
                statusBadge.textContent = 'â° íƒ€ì„ì•„ì›ƒ';
                statusBadge.className = 'status-badge status-error';
                return;
            }
            
            // ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì²´í¬
            updateCount++;
            if (updateCount > MAX_UPDATES) {
                addLog(`â° ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ë„ë‹¬ (${MAX_UPDATES}íšŒ): ëª¨ë‹ˆí„°ë§ì„ ì¤‘ì§€í•©ë‹ˆë‹¤.`);
                stopMonitoring();
                const statusBadge = document.getElementById('statusBadge');
                statusBadge.textContent = 'â° íƒ€ì„ì•„ì›ƒ';
                statusBadge.className = 'status-badge status-error';
                return;
            }
            
            try {
                const response = await fetch(`/api/music/${musicId}/`);
                const data = await response.json();
                
                if (response.ok) {
                    updateStatus(data);
                    
                    // audio_urlì´ ì—†ê³  ì¼ì • ì‹œê°„ì´ ì§€ë‚¬ìœ¼ë©´ ê²½ê³ 
                    if (!data.audio_url && updateCount > 20) {
                        addLog(`âš ï¸ ì•„ì§ ì˜¤ë””ì˜¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (${updateCount}íšŒ ì‹œë„)`);
                    }
                } else {
                    addLog(`âŒ ì˜¤ë¥˜: ${data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                    const statusBadge = document.getElementById('statusBadge');
                    statusBadge.textContent = 'âŒ ì˜¤ë¥˜';
                    statusBadge.className = 'status-badge status-error';
                    stopMonitoring();
                }
            } catch (error) {
                console.error('Error:', error);
                addLog(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
                
                // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ì—°ì†ìœ¼ë¡œ ë°œìƒí•˜ë©´ ì¤‘ì§€
                if (updateCount > 10) {
                    addLog('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ê³„ì† ë°œìƒí•˜ì—¬ ëª¨ë‹ˆí„°ë§ì„ ì¤‘ì§€í•©ë‹ˆë‹¤.');
                    stopMonitoring();
                }
            }
        }
        
        // ëª¨ë‹ˆí„°ë§ ì¤‘ì§€/ì¬ì‹œì‘ í•¨ìˆ˜
        function stopMonitoring() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
            isMonitoring = false;
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('startBtn').style.display = 'inline-block';
            addLog('â¹ï¸ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€ë¨');
        }
        
        function startMonitoring() {
            if (isCompleted) {
                addLog('âš ï¸ ì´ë¯¸ ì™„ë£Œëœ ìŒì•…ì…ë‹ˆë‹¤.');
                return;
            }
            isMonitoring = true;
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('startBtn').style.display = 'none';
            addLog('â–¶ï¸ ëª¨ë‹ˆí„°ë§ ì¬ì‹œì‘ë¨');
            
            // ì¦‰ì‹œ ì¡°íšŒ
            fetchMusicStatus();
            
            // 5ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸ (ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ë° íƒ€ì„ì•„ì›ƒ ì²´í¬ í¬í•¨)
            updateInterval = setInterval(() => {
                if (!isCompleted && isMonitoring) {
                    // íƒ€ì„ì•„ì›ƒ ë° ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì²´í¬
                    const elapsed = Date.now() - startTime;
                    if (elapsed > TIMEOUT_MS || updateCount >= MAX_UPDATES) {
                        stopMonitoring();
                        return;
                    }
                    fetchMusicStatus();
                    addLog(`ğŸ”„ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘... (${updateCount}/${MAX_UPDATES})`);
                }
            }, 5000);
        }
        
        // ì¤‘ì§€/ì¬ì‹œì‘ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('stopBtn').addEventListener('click', stopMonitoring);
        document.getElementById('startBtn').addEventListener('click', startMonitoring);
        
        // ì´ˆê¸°í™”
        document.getElementById('initTime').textContent = `[${new Date().toLocaleTimeString('ko-KR')}]`;
        addLog(`ğŸ” Music ID ${musicId} ì¡°íšŒ ì‹œì‘`);
        
        // ì¦‰ì‹œ ì²« ì¡°íšŒ
        fetchMusicStatus();
        
        // ì¤‘ì§€ ë²„íŠ¼ í‘œì‹œ
        document.getElementById('stopBtn').style.display = 'inline-block';
        
        // 5ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸ (ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ë° íƒ€ì„ì•„ì›ƒ ì²´í¬ í¬í•¨)
        updateInterval = setInterval(() => {
            if (!isCompleted && isMonitoring) {
                // íƒ€ì„ì•„ì›ƒ ë° ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì²´í¬
                const elapsed = Date.now() - startTime;
                if (elapsed > TIMEOUT_MS || updateCount >= MAX_UPDATES) {
                    addLog('â° íƒ€ì„ì•„ì›ƒ ë˜ëŠ” ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ë„ë‹¬: ëª¨ë‹ˆí„°ë§ì„ ì¤‘ì§€í•©ë‹ˆë‹¤.');
                    stopMonitoring();
                    const statusBadge = document.getElementById('statusBadge');
                    statusBadge.textContent = 'â° íƒ€ì„ì•„ì›ƒ';
                    statusBadge.className = 'status-badge status-error';
                    return;
                }
                fetchMusicStatus();
                addLog(`ğŸ”„ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘... (${updateCount}/${MAX_UPDATES})`);
            }
        }, 5000);
    </script>
</body>
</html>
