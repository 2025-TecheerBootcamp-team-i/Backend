services:
  traefik:
    # ğŸ‘‡ [ë³€ê²½ 1] ë²„ì „ì„ íŠ¹ì •í•˜ì§€ ì•Šê³  ìµœì‹ (latest)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    image: traefik:latest
    container_name: traefik
    # ğŸ‘‡ [ë³€ê²½ 2] ì„œë²„ API ë²„ì „(1.52)ì— ë§ì¶°ì¤ë‹ˆë‹¤.
    environment:
      - DOCKER_API_VERSION=1.52
    command:
      - "--api.insecure=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedByDefault=false"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entryPoints.websecure.address=:443"
      - "--entryPoints.web.http.redirections.entrypoint.to=websecure"
      - "--entryPoints.web.http.redirections.entrypoint.scheme=https"
      - "--certificatesResolvers.letsencrypt.acme.tlsChallenge=true"
      - "--certificatesResolvers.letsencrypt.acme.email=hhyunseung1216@gmail.com"
      - "--certificatesResolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--log.level=DEBUG"
      - "--accesslog=true"
      - "--accesslog.filepath=/traefik/logs/access.log"
      - "--accesslog.bufferingsize=100"
      - "--accesslog.format=json"
      - "--api.dashboard=true"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.addEntryPointsLabels=true"
      - "--metrics.prometheus.addServicesLabels=true"
      - "--entryPoints.metrics.address=:8091"
      - "--metrics.prometheus.entryPoint=metrics"
    ports:
      - "80:80"
      - "443:443"
      - "8090:8090"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "traefik-certificates:/letsencrypt"
      - "traefik_logs:/traefik/logs/"
    networks:
      - gitops-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mydashboard.rule=Host(`traefik.brokencarrot.my`)"
      - "traefik.http.routers.mydashboard.entryPoints=websecure"
      - "traefik.http.routers.mydashboard.service=api@internal"
      - "traefik.http.routers.mydashboard.tls.certResolver=letsencrypt"
      - "traefik.http.services.mydashboard.loadbalancer.server.port=8090"
     # - "traefik.http.routers.mydashboard.middlewares=auth"
     # - "traefik.http.middlewares.auth.basicauth.users=admin:$$apr1$$GNa.6c7.$$rvI2LPO/RRw93vwmZwUi3."

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    ports:
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - gitops-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"
      - "traefik.http.routers.portainer.entryPoints=websecure"
      - "traefik.http.routers.portainer.rule=Host(`portainer.brokencarrot.my`)"
      - "traefik.http.routers.portainer.tls.certResolver=letsencrypt"

networks:
  gitops-network:

volumes:
  traefik-certificates:
  portainer_data:
  traefik_logs:
